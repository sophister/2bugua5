# 【译】Zip炸弹：对抗恶意爬虫访问



原文链接： [https://idiallo.com/blog/zipbomb-protection](https://idiallo.com/blog/zipbomb-protection)

**译者注**： 相信有自己部署过web站点的同学，都会有这样的经历，各种恶意访问者层出不穷，有的甚至访问量还挺大，导致我们服务器带宽被打满、触发监控报警。通常我们可能会把这些恶意访问者的IP，加入到IP黑名单里，禁止其访问。本文作者提到另外一种，反向攻击对方的武器，感觉挺有意思。

---

### 我用 Zip 炸弹 来保护我的服务器


#### 机器人泛滥的网络世界

如今，网络上的大部分流量都来自机器人。大多数机器人用于发现新内容，比如 RSS 阅读器、搜索引擎爬虫，或者现在的 AI 机器人，用于抓取内容以训练大型语言模型（LLM）。但也有恶意机器人，比如垃圾邮件发送者、内容抓取者或黑客。

我曾在前公司工作时，遇到一个机器人发现了 WordPress 的漏洞，并在我们的服务器上插入了恶意脚本，最终将这台机器变成了用于 DDoS 攻击的僵尸网络。我的第一个网站也因为机器人生成的垃圾内容而被 Google 搜索引擎完全移除。

我必须找到一种方法来保护自己免受这些机器人的侵害。这时，我开始使用 Zip 炸弹。

---

#### 什么是 Zip 炸弹？

Zip 炸弹 是一种相对较小的压缩文件，但解压后会变成非常大的文件，足以压垮一台机器。

早期的网络开发中引入了 gzip 压缩功能。由于互联网速度慢，信息密度高，压缩数据以尽可能小的体积传输成为一种常见做法。例如，一个 50KB 的 HTML 文件可以压缩到 10KB，从而在传输中节省 40KB。在拨号上网时代，这意味着下载页面的时间从 12 秒缩短到 3 秒。

这种压缩也可用于传输 CSS、JavaScript 甚至图像。Gzip 快速、简单，极大地改善了浏览体验。当浏览器发出网页请求时，会在请求头中包含支持压缩的标志。如果服务器也支持压缩，就会返回压缩后的数据。

```
Accept-Encoding: gzip, deflate
```

爬虫机器人也支持这个功能。由于它们的任务是从整个网络中获取数据，使用压缩可以最大化带宽利用率。我们可以充分利用这一点。

---

#### 利用 Zip 炸弹 对抗恶意机器人

在我的博客中，经常有机器人扫描安全漏洞，我通常会忽略它们。但当我检测到它们试图注入恶意攻击或探测响应时，我会返回一个 200 OK 的响应，并提供一个 gzip 压缩的文件。我提供的文件大小从 1MB 到 10MB 不等，它们很乐意接收。但大多数情况下，它们接收后就再也没有回应了。为什么？因为它们在接收文件后崩溃了。

```
Content-Encoding: deflate, gzip
```

它们收到文件后，读取头部信息，得知这是一个压缩文件，于是尝试解压 1MB 的文件以查找所需内容。但文件不断扩展，直到耗尽内存，服务器崩溃。这个 1MB 的文件解压后变成了 1GB，这足以让大多数机器人崩溃。然而，对于那些顽固的脚本，我会提供一个 10MB 的文件，这个文件解压后变成 10GB，立即终结这些脚本。

---

#### 如何创建 Zip 炸弹

在告诉你如何创建 Zip 炸弹 之前，我必须警告你，这可能会导致你的设备崩溃甚至损坏。请自行承担风险。以下是创建 Zip Bomb 的方法：

```bash
dd if=/dev/zero bs=1G count=10 | gzip -c > 10GB.gz
```

这个命令的作用如下：

1. `dd`：用于复制或转换数据的命令。
2. `if`：输入文件，指定为 `/dev/zero`，这是一个特殊文件，产生无限的零字节流。
3. `bs`：块大小，设置为 1GB，意味着 dd 将以每次 1GB 的块读取和写入数据。
4. `count=10`：告诉 dd 处理 10 个块，每个块 1GB。因此，这将生成 10GB 的零数据。

然后，我们将命令的输出传递给 gzip，将其压缩成文件 `10GB.gz`。在这种情况下，生成的文件大小为 10MB。

---

#### 在服务器上部署 Zip 炸弹

在我的服务器上，我添加了一个中间件，用于检查当前请求是否恶意。我有一个黑名单，列出那些反复扫描整个网站的 IP 地址。我还使用其他启发式方法来检测垃圾邮件发送者。许多垃圾邮件发送者会尝试在页面上发布垃圾内容，然后回来查看这些内容是否成功发布。我利用这种模式来检测它们。代码大致如下：

```php
if (ipIsBlackListed() || isMalicious()) {
    header("Content-Encoding: deflate, gzip");
    header("Content-Length: " . filesize(ZIP_BOMB_FILE_10G)); // 10MB
    readfile(ZIP_BOMB_FILE_10G);
    exit;
}
```

就是这么简单。我唯一的代价是偶尔需要提供一个 10MB 的文件。如果我有一篇文章正在变得热门，我会把用于对付机器人的文件换成 1MB 的版本，这样能减轻服务器的压力，而且照样有效。（**高流量时减少资源消耗，同时保持 Zip 炸弹 的威慑效果**。）

---

#### 注意事项

Zip 炸弹 并非万无一失。它可以被轻易检测和规避。毕竟，你可以部分读取内容。但对于那些盲目爬取网络、扰乱服务器的低级机器人来说，这是一种足够有效的保护工具。

你可以在我的服务器日志重放中看到它的实际效果。

---

原文链接：[I use Zip Bombs to Protect my Server](https://idiallo.com/blog/zipbomb-protection)

---

>现在有了ChatGPT，感觉这类文章翻译太简便了，果然AI对我们这类 *键盘侠* 是无差别攻击的……
